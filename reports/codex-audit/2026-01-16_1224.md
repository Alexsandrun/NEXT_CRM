# Next_CRM Codebase Audit (Config/Doc/Security)
Date: 2026-01-16 12:24

## 1) Summary
The highest risk is a **config drift** between the gateway (nginx) and the content service port, which will break `/content/*` routing at runtime, and the presence of **dev authentication stubs** (default creds + unsigned tokens) that are not gated from production use. The repository is clearly positioned as a Block 0/1 dev skeleton, but several required contracts in DEV-CANON and the roadmap are not yet implemented (trace_id logging, `/version` in core).

Most issues cluster around **gateway routing, environment consistency, and security controls** (auth, tenant isolation, rate limiting, container hardening). These are minimal fixes that can be applied without large refactors.

## 2) Findings by Severity

### CRITICAL

**A) Gateway routes content to the wrong port**
- Severity: CRITICAL
- Files: `infra/nginx/dev.conf` (lines ~20–27), `docker-compose.yml` (lines ~48–63)
- What is wrong / why it matters:
  - Nginx proxies `/content/*` to `content:8000`, but the content service is started on port **8001**, so `/content/*` requests will fail (likely 502).
- Evidence:
  - `proxy_pass http://content:8000/;` vs `uvicorn ... --port 8001`
- Minimal fix suggestion:
  - Align nginx to `content:8001`, **or** run content on port 8000 and adjust healthcheck/compose accordingly.
- Prod impact? **YES** — gateway routing for the content plane will be broken.

### HIGH

**B) Default credentials and unsigned dev tokens (STUB/DEV-ONLY)**
- Severity: HIGH
- Files: `services/core/app/api/routes/auth.py` (lines ~10–43)
- What is wrong / why it matters:
  - Default admin credentials (`admin@demo.local` / `admin123`) and unsigned `devtoken.*` are issued without expiry or signing. This is acceptable only as a temporary stub but unsafe if reachable in non-dev environments.
- Evidence:
  - `ADMIN_PASSWORD = ... "admin123"` and `access_token=f"devtoken.{uuid.uuid4().hex}"`
- Minimal fix suggestion:
  - Gate the endpoint to dev-only (explicit env check + refuse in prod).
  - Use signed JWT with expiry and secrets from env/secret manager.
  - Add basic rate limiting on login.
- Prod impact? **YES** — if deployed without guardrails, this is a critical auth weakness.
- STUB/DEV-ONLY: **YES**, but **not enforced** by compose/nginx/docs.

**C) Tenant isolation not enforced in auth/bootstrap (STUB/DEV-ONLY)**
- Severity: HIGH
- Files: `services/core/app/api/routes/bootstrap.py` (lines ~10–29), `services/core/app/api/routes/auth.py` (lines ~29–44)
- What is wrong / why it matters:
  - Tenant IDs are set from env and not enforced in middleware/DB. This violates the DEV-CANON invariant for tenant isolation.
- Evidence:
  - `TENANT = os.getenv("BOOTSTRAP_TENANT", "demo")` and no tenant scoping checks.
- Minimal fix suggestion:
  - Add tenant scoping middleware and bind token claims to tenant.
  - Enforce tenant_id in DB queries before enabling non-dev usage.
- Prod impact? **YES** — multi-tenant data exposure risk.
- STUB/DEV-ONLY: **YES**, but **not enforced** by compose/nginx/docs.

**D) Containers run as root by default**
- Severity: HIGH
- Files: `docker-compose.yml` (lines ~20–88)
- What is wrong / why it matters:
  - Python services are started without a non-root user, increasing impact of RCE or container breakout.
- Evidence:
  - No `user:` directive or non-root Dockerfile usage for core/content/runner.
- Minimal fix suggestion:
  - Create non-root user in Dockerfile or set `user:` in compose.
  - Restrict volume permissions to least privilege.
- Prod impact? **YES** — elevated blast radius.

### MEDIUM

**E) ENV variable mismatch in core health output**
- Severity: MEDIUM
- Files: `services/core/app/main.py` (line ~15), `docker-compose.yml` (line ~27)
- What is wrong / why it matters:
  - Core reads `APP_ENV`, but compose provides `ENV`, so `/health` always reports default `dev`.
- Evidence:
  - `os.getenv("APP_ENV", "dev")` vs `ENV=${ENV:-dev}`
- Minimal fix suggestion:
  - Standardize on one env key (`ENV` or `APP_ENV`) in both code and compose.
- Prod impact? **MAYBE** — misreporting can hide environment drift.

**F) Missing `/version` in core (roadmap + DEV-CANON mismatch)**
- Severity: MEDIUM
- Files: `services/core/app/main.py` (no `/version`), `docs/01-index/DEV-CANON.md` (lines ~45–48), `docs/01-index/NEXT-STEPS-ROADMAP.md` (lines ~27–33)
- What is wrong / why it matters:
  - Roadmap and DEV-CANON require `/version` for services, but core does not expose it.
- Evidence:
  - `services/content` has `/version`; core does not.
- Minimal fix suggestion:
  - Add `/version` endpoint to core and include in smoke checks when Block 1 is targeted.
- Prod impact? **NO** — mostly affects observability and compliance with docs.

**G) Missing trace_id logging in core (roadmap + DEV-CANON mismatch)**
- Severity: MEDIUM
- Files: `services/core/app/main.py` (no structured logging), `docs/01-index/DEV-CANON.md` (lines ~48–56), `docs/01-index/NEXT-STEPS-ROADMAP.md` (lines ~27–30)
- What is wrong / why it matters:
  - Canon requires trace_id propagation and structured logs, but core lacks middleware/logging.
- Evidence:
  - No logging middleware; `/health` returns without trace_id.
- Minimal fix suggestion:
  - Add middleware to generate/propagate trace_id and JSON logs.
- Prod impact? **MAYBE** — impacts incident response and auditability.

**H) Missing rate limiting / abuse controls at gateway**
- Severity: MEDIUM
- Files: `infra/nginx/dev.conf` (no `limit_req`), `services/core/app/api/routes/auth.py`
- What is wrong / why it matters:
  - No request throttling for auth endpoints or gateway; risk of brute-force and DoS.
- Evidence:
  - No `limit_req` or throttling middleware.
- Minimal fix suggestion:
  - Add `limit_req`/`limit_conn` for `/api/auth/*` and general endpoints.
- Prod impact? **MAYBE** — depends on exposure.

### LOW

**I) Content service log sanitizer not implemented**
- Severity: LOW
- Files: `services/content/app/main.py` (lines ~13–23), `docs/01-index/DEV-CANON.md` (lines ~35–38)
- What is wrong / why it matters:
  - DEV-CANON requires log sanitization; content logs raw fields.
- Evidence:
  - `log()` emits payload with `**fields` and no sanitizer.
- Minimal fix suggestion:
  - Add sanitization/PII redaction before emitting JSON logs.
- Prod impact? **MAYBE** — depends on logged fields and deployment.

## 3) Doc Drift

- **DEV-CANON vs core implementation**: DEV-CANON mandates `/version` and trace_id logging for all services, but core lacks both. (Docs: `DEV-CANON.md` lines ~45–56; Roadmap Block 1 lines ~27–33).
- **Roadmap Block 1 vs code**: `NEXT-STEPS-ROADMAP.md` requires core `/version` and shared trace middleware; core does not implement them.
- **Gateway/content port mismatch**: docs describe routing but do not mention that content is on 8001, while nginx routes to 8000 (config drift between compose and nginx).

## 4) Known Stubs

- `services/core/app/api/routes/bootstrap.py` — bootstrap endpoint returns static tenant/admin IDs (STUB/DEV-ONLY).
- `services/core/app/api/routes/auth.py` — dev login with hardcoded defaults and unsigned tokens (STUB/DEV-ONLY).
- `services/runner/app/runner.py` — simple Redis ping loop (placeholder for event consumers).

## 5) Security

**S1) Default creds + unsigned tokens (STUB/DEV-ONLY)**
- Severity: HIGH
- Files: `services/core/app/api/routes/auth.py` (lines ~10–43)
- What is wrong / why it matters:
  - Fixed credentials and unsigned tokens allow trivial compromise if exposed.
- Evidence:
  - `ADMIN_PASSWORD = ... "admin123"`, `devtoken.*`
- Minimal fix suggestion:
  - Enforce dev-only guard; require JWT with exp/iat in any shared environment.
- Prod impact? **YES** — can lead to full account takeover.
- STUB/DEV-ONLY: **YES**, but not enforced.

**S2) Tenant isolation missing (STUB/DEV-ONLY)**
- Severity: HIGH
- Files: `services/core/app/api/routes/bootstrap.py`, `services/core/app/api/routes/auth.py`
- What is wrong / why it matters:
  - Tenant scoping is not enforced in code paths.
- Evidence:
  - Tenant pulled from env, no per-request tenant enforcement.
- Minimal fix suggestion:
  - Middleware + DB-level tenant scoping.
- Prod impact? **YES** — cross-tenant data exposure.
- STUB/DEV-ONLY: **YES**, but not enforced.

**S3) No rate limiting on gateway/auth**
- Severity: MEDIUM
- Files: `infra/nginx/dev.conf` (no rate limits)
- What is wrong / why it matters:
  - Brute-force and DoS not mitigated.
- Evidence:
  - No `limit_req`/`limit_conn` in nginx config.
- Minimal fix suggestion:
  - Add `limit_req` on `/api/auth/*` and general endpoints.
- Prod impact? **MAYBE** — depends on exposure.

**S4) Containers run as root by default**
- Severity: HIGH
- Files: `docker-compose.yml` (lines ~20–88)
- What is wrong / why it matters:
  - Increases impact of RCE inside container.
- Evidence:
  - No `user:` or non-root image usage.
- Minimal fix suggestion:
  - Run non-root user and restrict volume permissions.
- Prod impact? **YES**

**S5) Missing security headers/CORS policy**
- Severity: MEDIUM
- Files: `infra/nginx/dev.conf`, `services/core`/`services/content` (no CORS config)
- What is wrong / why it matters:
  - No HSTS/XFO/X-Content-Type-Options/CSP, no defined CORS allowlist.
- Evidence:
  - Nginx config only sets proxy headers; no security headers.
- Minimal fix suggestion:
  - Add security headers in nginx; configure explicit CORS policy.
- Prod impact? **MAYBE** — relevant for browser clients.

**S6) Traceability/log sanitization gaps**
- Severity: MEDIUM
- Files: `services/core/app/main.py` (no trace_id), `services/content/app/main.py` (logs w/out sanitizer), `services/runner/app/runner.py` (logs errors raw)
- What is wrong / why it matters:
  - Hinders incident response and may leak data in logs.
- Evidence:
  - No trace middleware in core; `log()` in content/runner prints raw fields.
- Minimal fix suggestion:
  - Add trace_id propagation and log sanitization per DEV-CANON.
- Prod impact? **MAYBE**

**S7) TLS not configured at gateway (dev-only)**
- Severity: LOW
- Files: `infra/nginx/dev.conf`
- What is wrong / why it matters:
  - HTTP only; acceptable for local dev but must not reach production.
- Evidence:
  - `listen 8080;` with no TLS configuration.
- Minimal fix suggestion:
  - Keep dev HTTP; add prod TLS configuration and document separation.
- Prod impact? **MAYBE** — only if dev config reused in prod.
- STUB/DEV-ONLY: **YES** (dev config), ensure prod configuration exists.
