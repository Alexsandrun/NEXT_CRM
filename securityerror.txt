Отчет по безопасности: потенциальные риски и рекомендации

1) Dev-аутентификация с постоянными учетными данными и токенами
- Где:
  - services/core/app/api/routes/auth.py: дефолтные логин/пароль (admin@demo.local / admin123) и выдача devtoken без подписи/срока.
- Риск:
  - Утечка или предсказуемость учетных данных, отсутствие срока жизни токена и подписи => высокий риск компрометации.
- Рекомендации:
  - Убрать дефолтные креденшелы из прод окружения и требовать секреты через env.
  - Ввести JWT с подписью и exp/iat, ограничить срок жизни, хранить секрет в менеджере секретов.
  - Добавить rate limiting и аудит логинов.

2) Отсутствие реального контроля авторизации/тенант-изоляции
- Где:
  - services/core/app/api/routes/bootstrap.py и auth.py: отсутствует проверка прав доступа, tenant_id фиксирован через env.
- Риск:
  - Нарушение требования tenant isolation и потенциальная эскалация прав.
- Рекомендации:
  - Реализовать tenant_id проверку на уровне middleware/DAO.
  - Привязать access token к tenant_id и проверять во всех эндпоинтах.

3) Отсутствие трассировки и корреляции в core (trace_id в логах)
- Где:
  - services/core/app/main.py и роуты: нет стандартизированного JSON-логирования с trace_id.
- Риск:
  - Сложность расследования инцидентов, неисполнение DEV-CANON требований.
- Рекомендации:
  - Добавить middleware для генерации trace_id и JSON-логов.
  - Включить trace_id в ответы ошибок.

4) Отсутствие ограничения частоты запросов
- Где:
  - Нет rate limiting на gateway/core (nginx конфиг без limit_req; FastAPI без throttling).
- Риск:
  - Возможность брутфорса / DoS.
- Рекомендации:
  - Добавить limit_req/limit_conn на nginx или middleware в core.

5) Использование root-пользователя в контейнерах по умолчанию
- Где:
  - docker-compose.yml: сервисы python запускаются без пользователя (по умолчанию root).
- Риск:
  - Повышение ущерба при RCE.
- Рекомендации:
  - Использовать non-root user в Dockerfile/compose, ограничить права на volume.

6) Отсутствие строгой политики CORS/headers безопасности
- Где:
  - services/core и services/content: нет настройки CORS/HTTP security headers.
- Риск:
  - Возможность злоупотребления браузерными вызовами, отсутствие защиты от XSS/CSRF на фронтовых интеграциях.
- Рекомендации:
  - Включить CORS с allowlist, добавить security headers на gateway.

7) Логи могут содержать чувствительные данные
- Где:
  - services/content/app/main.py: логирует data_dir и общие события без санитайзера.
  - services/runner/app/runner.py: логирует ошибки без фильтрации.
- Риск:
  - Потенциальная утечка чувствительной информации в логах.
- Рекомендации:
  - Ввести санитайзер логов согласно DEV-CANON.
  - Стандартизировать JSON-логи с фильтрацией PII.

8) Отсутствие шифрования трафика в dev/prod
- Где:
  - infra/nginx/dev.conf слушает HTTP без TLS.
- Риск:
  - MITM при доступе вне локальной сети, утечка токенов.
- Рекомендации:
  - Для prod включить TLS (dev может оставаться HTTP), задокументировать различие.

Итог:
- Критические риски: (1), (2), (4), (5).
- Средние: (3), (6), (7), (8).
